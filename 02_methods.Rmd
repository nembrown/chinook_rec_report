# Methods

## Revised catch estimates from 2013-present

### Internet Recreational Catch (iRec) Survey

The internet recreational effort and catch (iREC) survey is a recent method for estimating recreational fishing effort and catch in Pacific Region tidal waters. The iREC survey annually provides catch estimates and associated precision across all tidal water Pacific Fishery Management Areas (PFMA's), licenced fishing methods, species and fates (retained or released) at a monthly resolution (Houtman et al, 2015). For all fishing methods besides boat-based angling -- specifically angling from shore, shellfish trapping from boat or shore, beach collecting, hand picking, diving, and other methods -- these are the first estimates available.

#### Survey License Selection

When the iRec survey initially began in 2012, survey participants were selected from a provided subset of licence holders that purchased through a web based license purchasing system. This subset excluded any paper-based licences that were issued outside the web-based system and typically consisted of approximately XX% of all recreational licence holders. This subset of licence holders were contacted by email with instructions on how to ....

*Note: this sentence sort of just cut off - Nick?*

In more recent years (since 2018??) the iREC survey takes advantage of the web based purchasing of recreational licences to communicate survey selection and creating a sampling frame. Random selections of fishers with licences active in a given month are invited, via email, to provide details about their fishing activity and catch through a web-based survey tool. This fishing information from survey respondents is expanded to estimate total effort and catch following the methods described by Houtman et al. (2015).

The iRec survey is designed to provide month recreational catch estimates for every area within DFO's Pacific Region. When the survey was initially designed, the survey used the legal definition of Pacific Fishery Management Areas (PFMA) within the @pfma_2007.

#### License Stratification

When assessing survey responses, annual licences are unique compared to term licences as they can potentially fish any date after the licence purchase date and may be selected for one of several survey months within the licence year. To improve the representativeness of annual licence holders and provide a more consistent precision across months within the year, the licence selection process has used different stratification methods over the years the iRec has operated. Over the years, the approach to stratification has be adjusted to better align to improvements the in licence selection process and the increased number of selected licenses.

At the beginning of the iRec survey in 2012, licences were selected monthly, after the licence was purchased. Based on whether the annual licence was selected to respond to the survey for the month it was purchased in or for a survey month and were stratified into pre- and post-selection strata based on the licence purchase date. While nearly all term licences fished near the licence purchase date, the were all stratified as post-selection. However, annual licences may be selected for either a month they purchased the licence in or a future survey month. Selected annual licences purchased date was during the survey month, the licence was estimated in the post-selection strata for the survey month. For example if a licence was purchased on August 15th and they were selected for the August survey, the licence was stratified as a post-selection licence they in relation to their selected survey period. If the licence was purchased during the ...

### Creel Survey

Despite this potential bias, the iREC estimates are currently used, in a relative way, to prioritize the allocation of resources of creel surveys. Creel surveys are funded through contributions from Science (Salmon Stock Assessment) and Fisheries Management branches of Fisheries and Oceans Canada, ostensibly for the estimation of recreational salmon and Halibut catches although estimates for other finfish species are made. The iREC estimates of catch of these two species, along with boat-based recreational angling effort, are used to rank the most important month and area combinations for creel survey allocation purposes. Currently, creel surveys are focused on only those month -- area combinations contributing the highest combined retained catches of Chinook Salmon and Halibut. In times and locations where fishing effort and catch of these important species are low, creel surveys are not currently conducted (Houtman et al. 2015). In fact, for many month -- PFMA combinations, creel surveys or other recreational monitoring approaches have never been used to estimate recreational fishing effort or catch. The apparent bias in iREC estimates could result from numerous sources. With an invitational fisher-dependent survey of this type, there is potential that the respondents to the survey are not representative of all licenced fishers. Such 'response bias' could result from differential response rates by successful or unsuccessful fishers, active or inactive fishers, people who tend to inaccurately report their catch for prestige or strategic reasons as well as problems with recalling the details of their fishing activity. The survey is designed to minimize bias where possible, but not all sources of bias can be completely addressed through design or education. Without a source of alternative estimates of high accuracy, the overall magnitude and direction of bias is difficult to quantify.

Total annual catch estimates of boat-based angling would thus be equal to the sum of estimates from creel surveys for all months and areas where they occurred plus the iREC\* estimates for all months and areas where they did not. Despite the apparent simplicity of this calibration approach, there are outstanding issues regarding the use of creel survey estimates to calibrate iREC estimates; three of which we address here. First, creel surveys vary in sampling intensity and spatial and temporal coverage even with a particular month -- area estimate strata. This variability in the 'quality' of creel estimates (both in terms of accuracy and precision) may adversely affect calibration of iREC estimates. Second, variability in the relative strength and direction of "response bias" may influence the spatial or temporal patterns of bias in iREC estimates, with important implications for calibration. Finally, we combine information about the previous two issues to make recommendations about where, when and how to conduct relatively costly creel surveys to maximize their calibration value.

#### Creel quality control

Following the method used for iREC calibration (see DFO iREC report), we filtered the creel data based on quality criteria in a given area and month. Each monthly creel estimate included in our data was required to meet each of the following criteria:

*Note: Need Kris and Rob to flesh out these bullet points .... Why was at least 3 flights for each type of day chosen? Is that because in a month you typically get x amount of flights? Need to flesh out with context.*

-   At least 3 flights for each type of day (weekday or weekend)
-   At least 25 interviews mid week OR at least 10% of interviews from mid-week
-   At least 25 interviews on weekends OR at least 10% of interviews from weekend
-   At least 15 day spread in flights
-   At least 15 day spread in interviews

These quality control criteria are designed to avoid uncertainty where a monthly estimate was generated by expanding from only a small number of days or bias when generated only from a certain type of day (e.g. weekends). The criteria failed 51% of all estimates since 2005 (Figure \@ref(fig:fig-creel-criteria)). Areas 15 and 16 had the highest proportion of failed criteria, followed by Area 29, 19 (GS) and 21, which all had over 80% of estimates fail the criteria. The core summer months July and August have the highest rate of criteria passing (more than 70% of estimates passing), whereas the winter months (October through February) have more than 75% failed criteria, likely due to weather making consistent overflights difficult.

```{r Loading packages useful functions, message=FALSE, warning=FALSE, results='hide', echo=FALSE}

library(ROracle)
library(pacRecCatch)

library(tidyverse)
library(odbc)
library(lubridate)
library(ggnewscale)
library(patchwork)
library(DHARMa)
library(lme4)
library(bbmle)
library(SuppDists)
library(MuMIn)

col1 = "#d8e1cf"
col2 = "#438484"
col3 = "lightblue"
col4 = "lightblue4"
col5 = "pink"
col6 = "darkred"
col7 = "purple"
col8 = "purple4"
colclear= "#1C00ff00"

#utils
"%notin%" <- Negate("%in%")


```

```{r plotting PFMA creel unfiltered, echo=FALSE, message=FALSE, warning=FALSE, fig.height=12, fig.width=15, out.width = "7in", fig.align = "left"}
#| label: fig-creel-criteria
#| fig-cap: "Creel estimates that passed (green) or failed (red) quality control criteria by month and PFMA."

creel_month_PFMA<-filter_creel_catch("pacRecCatch_db.yaml")
Creel_month_PFMA_failed<-creel_month_PFMA %>% filter(criteria == "failed")
Creel_month_PFMA_passed<-creel_month_PFMA %>% filter(criteria == "passed")

g<-ggplot()+
  geom_tile(data=Creel_month_PFMA_passed %>% mutate(across(where(is.numeric), ~na_if(., 0)))  %>%  filter(AREA %notin% c("Area 3", "Area 4")), aes(x=YEAR, y=as.factor(MONTH), fill = VAL),colour = "white") +
  scale_fill_gradient(low = col1, high = col2,  na.value = colclear, limits=c(0,20000)) +
  scale_y_discrete(limits=rev)+
  guides(fill=guide_legend(title="Creel estimates that passed criteria")) +
  new_scale_fill() +
  geom_tile(data=Creel_month_PFMA_failed %>% mutate(across(where(is.numeric), ~na_if(., 0))) %>%  filter(AREA %notin% c("Area 3", "Area 4")), aes(x=YEAR, y=as.factor(MONTH), fill = VAL),colour = "white") +
  scale_fill_gradient(low = col5, high = col6,  na.value = colclear, limits=c(0,20000))+
  facet_wrap(~AREA)+
  guides(fill=guide_legend(title="Creel estimates that failed criteria")) +
  labs(title = "Coverage by PFMA",
       x = "Year", y = "Month") +
  theme_bw() + theme_minimal() + theme(legend.position="bottom")

g
```

### Combining iREC and creel estimates (2013 - present)

We pulled raw recreational catch data from the CREST database. This database stores creel, logbook, and iREC data for both marine and freshwater regions. We filtered the data to contain only marine estimates for legal-sized marked and unmarked fish that were kept and released. We loaded in data from Northern and Central BC separately since the information in CREST is incomplete for these regions. We filtered the creel data as described above to only include high quality creel estimates. These estimates (which don't include submissions from logbooks) were then augmented with logbook data where available (logbook and creel estimates were summed).

*\*\* Note: Two points:*

1.  *explain how iREC was incorporated in the past (i.e. not by PFMA but at the era fishery level) --\> for catch and escapement report at least*
2.  *explain how south coast did it's own iREC infilling and how this is replacing that.*

#### iRec to Creel Calibration

Where absolute estimates of effort and catch are demanded, such as for allocation decisions, stock assessments and catch reporting requirements, calibration of iREC estimates would be required. Calibrated iREC estimates for boat-based angling would be achieved by scaling iREC to creel estimates using the regression parameters (slope [m]) of iREC -- creel regressions for equivalent month -- area pairs. The calibrated iREC point estimates of boat-based angling effort or species specific catch (iREC\*) would be simply:

$$iRec^*=\frac{(iRec)}{m}$$

Use of JAGS

```{r, echo=TRUE}
model.jags <- function() {
  for(i in 1:Ndata) {
     #generate what true value may be based on se (notice that dnorm in jags
     # uses 1/variance for second argument thus 1/SE^2)
     creel.true[i] ~ dnorm(creel.obs[i], 1/creel.se[i]*1/creel.se[i])
     
     #now for the actual regression equation
     mu[i] <- beta1 * creel.true[i]
     iRec.obs[i] ~ dnorm(mu[i], tau)
  }
  
  beta1 ~ dnorm(0, 0.0001)
  tau ~ dgram(0.01, 0.01) #a common prior for a variance term in vertical direction
  
  #derived variables
  sigma <- 1/sqrt(tau) #std deviation about the regression line
}
```

Forced through the origin (need background?)

#### Alignment issues

iREC and creel both operate on the Pacific Fisheries Management Area system. However, there are a few areas that were initially not split by the iREC system into their component parts, as done in the creel database. These include areas 2, 19, 20, and 23. We therefore combined data from 2013 until the split was successfully incorporated into iREC (licence year 2014 for Areas 2,19, and 23; licence year 2020 for Area 20).

*\*\*Note: Add something about ISBM corridor alignment issue and how we handle it -i.e. iREC is just the whole PFMA.*

#### Extrapolating unchecked catch by mark rate

All data is typically collected in number of marked and unmarked fish kept and released. However, when mark status is unknown, the catch estimates can be provided as unchecked kept and unchecked released catch. We extrapolated these unchecked estimates to marked and unmarked catch using mark rate.

*Note: add in Nick's MRP mark rate data to this list. Is it preferred?*

We calculated mark rate in a number of different ways and prioritize the assignment of mark rate in the following order:

1.  Monthly area calculation - Mark rate calculated for a given source (iREC, creel, or logbook) within a given year, month, and area
2.  Monthly average by source - Mark rate calculated within a given year, month, and area, averaged across sources
3.  Monthly regional average - Mark rate calculated for a given source within a given year, month, and region (averaged across areas within a region)
4.  Seasonal area average - Mark rate calculated for a given source (iREC, creel, or logbook) within a given year, season, and area
5.  Seasonal regional average -Mark rate calculated for a given source within a given year, season, and region
6.  Monthly area average across years - Mark rate calculated for a given source within a given month, area, and across years
7.  Monthly regional average across years- Mark rate calculated for a given source within a given month, region, and across years

#### Choosing best monthly catch estimate per PFMA

We used the following rules to choose the best catch estimate between creel (augmented with logbook data) and calibrated iREC:

For Southern BC:

-   In months May-September (5-9) use creel+ logbook, otherwise use calibrated iREC

-   In months outside of 5-9, use calibrated iREC

For Northern and Central BC:

-   Use calibrated iREC from 2015 onwards

These rules prioritize quality-controlled creel estimates during months where the most creel effort is concentrated, and then prioritizes iREC data during shoulder seasons and anywhere there is a gap in creel coverage. Northern and Central BC do not have standardized creel, and therefore the iREC data is preferred over logbook-only data. iREC took longer to become adopted in Northern BC and therefore data from 2015 onwards is used.

In Figure \@ref(fig:fig-creel-irec-JDF) we demonstrate how iREC fills in the gaps in each PFMA for a given finescale fishery (Juan De Fuca shown as an example).

```{r pfma_month again, message=FALSE, warning=FALSE, results='hide', echo=FALSE}

Sport_mark_rate_finescale<-wrangle_rec_catch("pacRecCatch_db.yaml", by="area")

pfma_yearMonth <- plyr::ddply(Sport_mark_rate_finescale, c( "YEAR", "MONTH", "AREA", "finescale_fishery_old"), summarise,
                         sum_creel = sum(creel, na.rm = TRUE), sum= sum(creel_plus, na.rm = TRUE), sum_historic= sum(historic_plus, na.rm = TRUE), sum_catch_estimate = sum(catch_estimate, na.rm = TRUE), sum_irec = sum(irec_calibrated, na.rm = TRUE)) %>% mutate(across(where(is.numeric), ~na_if(., 0))) %>% filter(finescale_fishery_old!="NA")

pfma_yearMonth_catch_estimate_1<-pfma_yearMonth  %>% filter(sum_catch_estimate!=sum,sum_catch_estimate!=sum_historic, sum_catch_estimate!=sum_irec)

pfma_yearMonth_irec_1<-pfma_yearMonth  %>% filter(sum_catch_estimate==sum_irec)
```

```{r plotting PFMA - Juan de Fuca, echo=FALSE, message=FALSE, warning=FALSE, fig.height=2, fig.width=10}
#| label: fig-creel-irec-JDF
#| fig-cap: "Creel estimates in Juan de Fuca by area and month and chosen best catch estimate between creel and iREC"

g<-ggplot()+
  geom_tile(data=pfma_yearMonth %>% filter(finescale_fishery_old=="CA JDF S"), aes(x=YEAR, y=as.factor(MONTH), fill = sum_catch_estimate),colour = "white") +
  scale_fill_gradient(low = col1, high = col2,  na.value = colclear, limits=c(0,90000)) +
  scale_y_discrete(limits=rev)+
  guides(fill=guide_legend(title="creel or logbook estimates")) +
  new_scale_fill() +
  geom_tile(data=pfma_yearMonth_irec_1 %>% filter(finescale_fishery_old=="CA JDF S"), aes(x=YEAR, y=as.factor(MONTH), fill = sum_catch_estimate),colour = "white") +
  scale_fill_gradient(low = col5, high = col6,  na.value = colclear, limits=c(0,90000))+
  facet_wrap(~finescale_fishery_old+AREA, nrow=1)+
  guides(fill=guide_legend(title="iREC estimates")) +
  labs(title = "Coverage by PFMA",
       x = "Year", y = "Month") +
  theme_bw() + theme_minimal() + geom_vline(xintercept = 2013)+ theme(legend.position="bottom")

g
```

## Revised catch estimates from 2005-2012

Where iREC is unavailable (before 2013), we model iREC-incorporated seasonal catch estimates by finescale fishery using the relationship between summertime creel estimates without iREC and seasonal iREC-incorporated catch estimates from 2013-2023. These seasonal estimates are then rolled up into yearly estimates.

### Splitting fisheries by season

Following the rules for incorporating iREC, we split previous fisheries in spring (months 1:4), summer (months 5:9) and fall (10:12) seasons. A few exceptions were made, for example WCVI ISBM doesn't have a spring fishery since no ISBM fisheries occur in the spring. We split fisheries by season in order to better pool estimates since there are not always iREC or creel estimates for each month.

*Note on terminal finescale fisheries \*\*\*\* they get the same as the "summer" estimates.....*

### Identifying a summer creel period

We identified a fishery specific consistently creeled or logbooked coverage period for the summer period where there is consistent data throughout the time series (from 2005 to 2023) from the creel + logbook data. The summer coverage period included all months within 7:8 that are consistent through the timeseries. This consistent chunk of data will be used to predict the estimated catch in the section of the time series where we don't have iREC. This data is unfiltered creel + logbook catch estimates.

### Modeling protocol

We investigated various models using a systematic approach:

-   Separate models for all southern BC fisheries and Northern and Central BC since the data inputs are different

-   One model for spring and fall pre-terminal sport fisheries since these are iREC-only data

-   One model for summer pre-terminal sport fisheries since these are iREC and creel combined data

-   Same dataset tested for all models - therefore done without NAs

-   We didn't consider random effects models since we don't have enough levels of each factor to warrant random effects inclusion (need \>10 typically)

-   For all candidate models we used the DHARMa package to create a qq-plot to detect deviations in observations from expected distribution and a plot of the residuals against predicted values to detect patterns in residuals. We visually assessed whether candidate models improved plots.

-   We also compared candidate models using AIC, a lower AIC indicating a better model fit.

The order of comparisons was as follows:

-   First we compared three distributions: normal (gaussian), poisson, and Gamma distribution to see which fit our data the best on the full model. These distributions are all consistent with our positive, continuous data

    $$
    catch = creel.summer * status * finescale.fishery * season 
    $$

-   Next, using the chosen distribution, we compared the full model with all terms to models with each of the terms dropped sequentially except for creel.summer which was our main interest. We did this first by dropping out full terms from the full interaction model, then used the dredge function in MuMIn to sequentially drop out the various sub-interactions

-   In each case, we selected the model with the lowest AIC and best visual diagnostics.

### Model validation with Sport Head Recovery Program 

We validated the modelling output with the sport head recovery program by regressing both the observed catch (2013-2023) and the modelled catch (2005-2012) with heads recovered by the the sport head recovery program which receives voluntary head submissions for recovering CWT tags.

*Note: More detail here. I.e. comparing the slopes of heads submitted with marked kept catch and the modelled catch, similar slopes = similar submission rates.*

## Incorporating revised estimates in CTC processes (inputs)

The revised catch estimates from modeled data from 2005 to 2012 and from improved data from 2013-2023 were re-inserted into the CTC process. Notably, catch estimates are used in:

1) CWT Estimation process. CWTs were re-estimated with the revised data for adclipped catch and re-published to RMIS.

2) Catch and Escapement Report Kept and Released \# fish by ERA fishery

3) Exploitation Rate Analysis Chinook non-retention. This year the ERA is switching from a model that only accounts Chinook non-retention without selectively to non-retention by mark status, therefore the applicable rates in the ERA that are modified are the marked released rate (MRR) and unmarked kept rate (UKR).

-   *Note: Explain the method here for MRR and UKR averaging before 2013, to keep it consistent ... except for Juan de Fuca 2008 on wards*

## Incorporating revised estimates in CTC processes (outputs) 

4) CYER outputs .... *note changes from including MRR and UKR as well.*
