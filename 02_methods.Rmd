# Methods

## Creel quality control

Following the method used for iREC calibration (see DFO iREC report), we filtered the creel data based on quality criteria in a given area and month. Each monthly creel estimate included in our data was required to meet each of the following criteria:

-   At least 3 flights for each type of day (weekday or weekend)
-   At least 25 interviews mid week OR at least 10% of interviews from mid-week
-   At least 25 interviews on weekends OR at least 10% of interviews from weekend
-   At least 15 day spread in flights
-   At least 15 day spread in interviews

These quality control criteria are designed to avoid uncertainty where a monthly estimate was generated by expanding from only a small number of days or bias when generated only from a certain type of day (e.g. weekends). The criteria failed 51% of all estimates since 2005 (Figure \@ref(fig:fig-creel-criteria)). Areas 15 and 16 had the highest proportion of failed criteria, followed by Area 29, 19 (GS) and 21, which all had over 80% of estimates fail the criteria. The core summer months July and August have the highest rate of criteria passing (more than 70% of estimates passing), whereas the winter months (October through February) have more than 75% failed criteria, likely due to weather making consistent overflights difficult.

```{r Loading packages useful functions, message=FALSE, warning=FALSE, results='hide', echo=FALSE}

library(tidyverse)
library(odbc)
library(lubridate)
library(ggnewscale)
library(patchwork)
library(DHARMa)
library(lme4)
library(bbmle)
library(SuppDists)
library(MuMIn)

col1 = "#d8e1cf"
col2 = "#438484"
col3 = "lightblue"
col4 = "lightblue4"
col5 = "pink"
col6 = "darkred"
colclear= "#1C00ff00"

#utils
"%notin%" <- Negate("%in%")

Creel_Sport_mark_rate_finescale<-read_rds("data/Creel_Sport_mark_rate_finescale.RDS")

Sport_mark_rate_finescale<-read_rds("data/Sport_mark_rate_finescale.RDS")

Sport_mark_rate_finescale_combined<-read_rds("data/Sport_mark_rate_finescale_combined.RDS")

models_combined<- read_rds("data/models_combined.RDS")

Season_south_no_nas<-read_rds("data/Season_south_no_nas.RDS")
Summer_south_no_nas<-read_rds("data/Summer_south_no_nas.RDS")
Season_north_aabm_no_nas<-read_rds("data/Season_north_aabm_no_nas.RDS")
Season_north_isbm_no_nas<-read_rds("data/Season_north_isbm_no_nas.RDS")
Season_cbc_isbm_no_nas<-read_rds("data/Season_cbc_isbm_no_nas.RDS")
Summer_north_aabm_no_nas<-read_rds("data/Summer_north_aabm_no_nas.RDS")
Summer_north_isbm_no_nas<-read_rds("data/Summer_north_isbm_no_nas.RDS")

Season_south_combined<-read_rds("data/Season_south_combined.RDS")
Summer_south_combined<-read_rds("data/Summer_south_combined.RDS")
Season_north_aabm_combined<-read_rds("data/Season_north_aabm_combined.RDS")
Summer_north_aabm_combined<-read_rds("data/Summer_north_aabm_combined.RDS")
Season_north_isbm_combined<-read_rds("data/Season_north_isbm_combined.RDS")
Season_cbc_isbm_combined<-read_rds("data/Season_cbc_isbm_combined.RDS")
Summer_north_isbm_combined<-read_rds("data/Summer_north_isbm_combined.RDS")


Creel_month_PFMA_failed<- read_rds("data/Creel_month_PFMA_failed.RDS")
Creel_month_PFMA_passed<- read_rds("data/Creel_month_PFMA_passed.RDS")


```

```{r plotting PFMA creel unfiltered, echo=FALSE, message=FALSE, warning=FALSE, fig.height=12, fig.width=15}
#| label: fig-creel-criteria
#| fig-cap: "Creel estimates that passed (green) or failed (red) quality control criteria by month and PFMA."


g<-ggplot()+
  geom_tile(data=Creel_month_PFMA_passed %>% mutate(across(where(is.numeric), ~na_if(., 0)))  %>%  filter(AREA %notin% c("Area 3", "Area 4")), aes(x=YEAR, y=as.factor(MONTH), fill = VAL),colour = "white") +
  scale_fill_gradient(low = col1, high = col2,  na.value = colclear, limits=c(0,20000)) +
  scale_y_discrete(limits=rev)+
  guides(fill=guide_legend(title="Creel estimates that pass criteria")) +
  new_scale_fill() +
  geom_tile(data=Creel_month_PFMA_failed %>% mutate(across(where(is.numeric), ~na_if(., 0))) %>%  filter(AREA %notin% c("Area 3", "Area 4")), aes(x=YEAR, y=as.factor(MONTH), fill = VAL),colour = "white") +
  scale_fill_gradient(low = col5, high = col6,  na.value = colclear, limits=c(0,20000))+
  facet_wrap(~AREA)+
  guides(fill=guide_legend(title="Creel estimates that failed criteria")) +
  labs(title = "Coverage by PFMA",
       x = "Year", y = "Month") +
  theme_bw() + theme_minimal() 

g
```

## Combining iREC and creel estimates (2013 - present)

We pulled raw recreational catch data from the CREST database. This database stores creel, logbook, and iREC data for both marine and freshwater regions. We filtered the data to contain only marine estimates for legal-sized marked and unmarked fish that were kept and released. We loaded in data from Northern and Central BC separately since the information in CREST is incomplete for these regions. We filtered the creel data as described above to only include high quality creel estimates. These estimates (which don't include submissions from logbooks) were then augmented with logbook data where available (logbook and creel estimates were summed).

### Alignment issues

iREC and creel both operate on the Pacific Fisheries Management Area system. However, there are a few areas that were initially not split by the iREC system into their component parts, as done in the creel database. These include areas 2, 19, 20, and 23. We therefore combined data from 2013 until the split was successfully incorporated into iREC (licence year 2014 for Areas 2,19, and 23; licence year 2020 for Area 20).

\*\*Note about ISBM corridor alignment issue and how we handle it.

### Extrapolating unchecked catch by mark rate

All data is typically collected in number of marked and unmarked fish kept and released. However, when mark status is unknown, the catch estimates can be provided as unchecked kept and unchecked released catch. We extrapolated these unchecked estimates to marked and unmarked catch using mark rate.

We calculated mark rate in a number of different ways and prioritize the assignment of mark rate in the following order:

1.  Monthly area calculation - Mark rate calculated for a given source (iREC, creel, or logbook) within a given year, month, and area
2.  Monthly average by source - Mark rate calculated within a given year, month, and area, averaged across sources
3.  Monthly regional average - Mark rate calculated for a given source within a given year, month, and region (averaged across areas within a region)
4.  Seasonal area average - Mark rate calculated for a given source (iREC, creel, or logbook) within a given year, season, and area
5.  Seasonal regional average -Mark rate calculated for a given source within a given year, season, and region
6.  Monthly area average across years - Mark rate calculated for a given source within a given month, area, and across years
7.  Monthly regional average across years- Mark rate calculated for a given source within a given month, region, and across years

### Choosing best monthly catch estimate per PFMA

We used the following rules to choose the best catch estimate between creel (augmented with logbook data) and calibrated iREC:

For Southern BC:

-   In months May-September (5-9) use creel+ logbook, otherwise use calibrated iREC

-   In months outside of 5-9, use calibrated iREC

For Northern and Central BC:

-   Use calibrated iREC

These rules prioritize quality-controlled creel estimates during months where the most creel effort is concentrated, and then prioritizes iREC data during shoulder seasons and anywhere there is a gap in creel coverage. Northern and Central BC do not have standardized creel, and therefore the iREC data is preferred over logbook-only data.

In Figure () we demonstrate how iREC fills in the gaps in each PFMA.

```{r pfma_month again, message=FALSE, warning=FALSE, results='hide', echo=FALSE}

pfma_yearMonth <- plyr::ddply(Sport_mark_rate_finescale, c( "YEAR", "MONTH", "AREA", "finescale_fishery_old"), summarise,
                         sum_creel = sum(creel, na.rm = TRUE), sum= sum(creel_plus, na.rm = TRUE), sum_historic= sum(historic_plus, na.rm = TRUE), sum_catch_estimate = sum(catch_estimate, na.rm = TRUE), sum_irec = sum(irec_calibrated, na.rm = TRUE)) %>% mutate(across(where(is.numeric), ~na_if(., 0))) %>% filter(finescale_fishery_old!="NA")


pfma_yearMonth_catch_estimate_1<-pfma_yearMonth  %>% filter(sum_catch_estimate!=sum,sum_catch_estimate!=sum_historic, sum_catch_estimate!=sum_irec)

pfma_yearMonth_irec_1<-pfma_yearMonth  %>% filter(sum_catch_estimate==sum_irec)
```

#### Juan de Fuca

```{r plotting PFMA - Juan de Fuca, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=10}

g<-ggplot()+
  geom_tile(data=pfma_yearMonth %>% filter(finescale_fishery_old=="CA JDF S"), aes(x=YEAR, y=as.factor(MONTH), fill = sum_catch_estimate),colour = "white") +
  scale_fill_gradient(low = col1, high = col2,  na.value = colclear, limits=c(0,90000)) +
  scale_y_discrete(limits=rev)+
  guides(fill=guide_legend(title="creel or logbook estimates")) +
  new_scale_fill() +
  geom_tile(data=pfma_yearMonth_irec_1 %>% filter(finescale_fishery_old=="CA JDF S"), aes(x=YEAR, y=as.factor(MONTH), fill = sum_catch_estimate),colour = "white") +
  scale_fill_gradient(low = col5, high = col6,  na.value = colclear, limits=c(0,90000))+
  facet_wrap(~finescale_fishery_old+AREA, nrow=1)+
  guides(fill=guide_legend(title="iREC estimates")) +
  labs(title = "Coverage by PFMA",
       x = "Year", y = "Month") +
  theme_bw() + theme_minimal() + geom_vline(xintercept = 2013)

g
```
