\clearpage

# Results

```{r results loading data, message=FALSE, warning=FALSE, results='hide', echo=FALSE}

library(ROracle)
library(pacRecCatch)
library(tidyverse)
library(odbc)
library(lubridate)
library(ggnewscale)
library(patchwork)
library(DHARMa)
library(lme4)
library(bbmle)
library(SuppDists)
library(MuMIn)

Sport_mark_rate_finescale_combined<-wrangle_rec_catch("pacRecCatch_db.yaml", by="fishery")

Sport_mark_rate_finescale<-wrangle_rec_catch("pacRecCatch_db.yaml", by="area")


models_combined <- pacRecCatch::model_rec_catch(Sport_mark_rate_finescale_combined)


Sport_mark_rate_mrr_corrected<-get_release_rates(models_combined, Sport_mark_rate_finescale)

```

## Revised Chinook catch estimates from 2013-present

Unsurprisingly, we found that catch estimates that included iREC data were generally higher than previous estimates that didn't include iREC information. As an example, Figure \@ref(fig:fig-jdf-catch-revised-1) shows the effect of the summed and revised kept catch estimates for 2013-2023 for Juan de Fuca (solid line) compared to the previous estimates without iREC inclusion (dashed line). In 2023, the revised estimates were 19% higher than the estimates without iREC included. However, in 2019, the revised estimates were smaller than the previous estimates, likely due to the creel filtration process removing a biased creel estimate. The revised kept catch plots for the remaining fisheries can be found in Appendix A \@ref(fig-catch-revised-1-appendix).

*Note: should this be by ERA fishery instead?*

```{r results example summer m plots, results='asis', echo=FALSE}
#| label: fig-jdf-catch-revised-1
#| fig-cap: "Juan de Fuca revised yearly catch estimates"


### make this by finescale fishery old... sum up. 
models_combined_old<-models_combined %>% group_by(YEAR,kept_status,pred_cat, finescale_fishery_old) %>% summarise_if(is.numeric, sum, na.rm = TRUE)

fishery_name_south<- sort(unique(models_combined_old$finescale_fishery_old))


i = 1

 m<-ggplot(models_combined_old  %>% filter(finescale_fishery_old==fishery_name_south[i], YEAR %in% c(2013:2023), kept_status=="Kept")) +
    geom_point(size=2.5,  aes(y=creel_unfiltered_plus, x=YEAR,col=kept_status, fill=kept_status, shape=pred_cat))+
    geom_line(aes(y=creel_unfiltered_plus, x=YEAR,col=kept_status, linetype = " Unfiltered creel and logbook"))+
    scale_shape_manual(values=c(1,1), guide="none")+
    scale_x_continuous(breaks = c(2013, 2015, 2017, 2019, 2021, 2023))+
    new_scale("shape")+
    scale_colour_viridis_d()+
    geom_point(size=2.5, aes(y=catch_estimate_predicted, x=YEAR,col=kept_status, fill=kept_status, shape=pred_cat))+
    geom_line(aes(y=catch_estimate_predicted, x=YEAR,col=kept_status, linetype = "iREC included"))+
    scale_shape_manual(values=c(16,17), guide="none")+
    scale_linetype_manual(values=c(2,1))+
   ggtitle(paste(fishery_name_south[i])) + theme_bw() + scale_x_continuous(breaks = c(2013, 2015, 2017, 2019, 2021, 2023))+ ylab("Kept catch estimate") + xlab("Year")
 
 print(m)
```

## Revised Chinook catch estimates from 2005-2012

### Model fit

#### Summer models

Separate models were developed for summer finescale fisheries as for the combined spring and fall fisheries (with season as a factor). Since Central BC did not have off-season fisheries, one year-round model was developed for CBC Sport. One summer model was deveoped for all southern BC fisheries, and a separate model each for NBC AABM and NBC ISBM. Overall, models that fit creel summer to creel + iREC summer were a better fit when compared to the models that fit summer creel to data from spring and fall seasons (Appendix A for residual plots). All the models retained the variable "status" - which fits a different slope to each of the categories Marked Kept, Marked Released, Unmarked Kept and Unmarked Released.

##### Southern BC Summer Fisheries

The best model was one with a gamma distribution with a log link which included summer creel, marked and kept status, finescale fishery, and various interactions of these terms:

$$ catch = creel.summer+finescale.fishery+status+                                               creel.summer:finescale.fishery  + 
creel.summer:status + status:finescale.fishery                                             $$

Figure \@ref(fig:fig-south-sum-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. Figure \@ref(fig:fig-jdf-summer-model) shows an example of the Summer model results in Juan de Fuca. The model fit plots for the remaining southern BC fisheries can be found in Appendix B.

```{r results example seasonal summer, results='asis', echo=FALSE}
#| label: fig-jdf-summer-model
#| fig-cap: "Juan de Fuca Summer fishery modelled relationship between concentrated summertime unfiltered creel estimate (months 7 and 8) and total catch estimate including iREC in summer months (5-9). Data points are yearly estimates from 2013 to 2023."

Summer_south<-Sport_mark_rate_finescale_combined %>%
  filter(YEAR %in% c(2013:2023))%>%
  filter(!str_detect(finescale_fishery, "CBC|NBC")) %>%
  filter(season %in% c("summer"))

Summer_south_no_nas<-Summer_south %>% drop_na(any_of(c("creel_plus_summer", "status", "finescale_fishery_old")))

Summer_model<- glm(formula = catch_estimate ~ finescale_fishery_old + status + creel_plus_summer:finescale_fishery_old + creel_plus_summer:status +
finescale_fishery_old:status + 1 + creel_plus_summer,  family=Gamma(link = "log"), data = Summer_south_no_nas)

#### Adding confidence intervals based on model to a dataframe for plotting purposes
#based on this blog: https://fromthebottomoftheheap.net/2018/12/10/confidence-intervals-for-glms/

family.set <- family(Summer_model)
ilink.family.set<- family.set$linkinv

mod<-Summer_model

ndata<-Summer_south_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(creel_plus_summer = seq(0, max(creel_plus_summer), length=100))
  

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))

fishery_name_south<- sort(unique(Summer_south_no_nas$finescale_fishery))

i =1


dataminmax_marked_kept<- Summer_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Kept_total")
dataminmax_marked_released<- Summer_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Summer_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Summer_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Released_total")


g1<-ggplot(Summer_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Kept_total"), aes(x=creel_plus_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Kept_total"), mapping=aes(y= fit, x=creel_plus_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Kept_total"), mapping=aes(y= fit,x=creel_plus_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#440154"))+  scale_fill_manual(values=c("#440154"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_kept$catch_estimate)), xlim = c(0,max(dataminmax_marked_kept$creel_plus_summer)))

g2<-ggplot(Summer_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Released_total"), aes(x=creel_plus_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Released_total"), mapping=aes(y= fit, x=creel_plus_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Released_total"), mapping=aes(y= fit,x=creel_plus_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
 scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#31688e"))+  scale_fill_manual(values=c("#31688e"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_released$catch_estimate)), xlim = c(0,max(dataminmax_marked_released$creel_plus_summer)))

g3<-ggplot(Summer_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Kept_total"), aes(x=creel_plus_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Kept_total"), mapping=aes(y= fit, x=creel_plus_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Kept_total"), mapping=aes(y= fit,x=creel_plus_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#35b779"))+  scale_fill_manual(values=c("#35b779"))+
  coord_cartesian(ylim = c(0,max(dataminmax_unmarked_kept$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_kept$creel_plus_summer)))

g4<-ggplot(Summer_south_no_nas%>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Released_total"), aes(x=creel_plus_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Released_total"), mapping=aes(y= fit, x=creel_plus_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Released_total"), mapping=aes(y= fit,x=creel_plus_summer, ymin = right_lwr, ymax = right_upr, fill=status, col=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#d4be02"))+  scale_fill_manual(values=c("#d4be02"))+
    coord_cartesian(ylim = c(0,max(dataminmax_unmarked_released$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_released$creel_plus_summer)))

g<-g1+g2 + g3+g4 + plot_layout(guides = "collect") 
print(g)

```

##### Northern BC AABM Summer Fisheries

The best model was one with a gamma distribution with a log link which included summer historic data (logbook), marked and kept status, and an interactions of these terms:

$$ catch = historic.summer+status + historic.summer:status                                            $$

Figure \@ref(fig:fig-nbcaabm-sum-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. Figure \@ref(fig:fig-nbcaabm-summer-model) shows the summer model results in NBC AABM.

```{r results NBC AABM summer, results='asis', echo=FALSE}
#| label: fig-nbcaabm-summer-model
#| fig-cap: "NBC AABM modelled results for Summer fishery"


Summer_north_aabm<-Sport_mark_rate_finescale_combined%>%
  filter(YEAR %in% c(2015:2023)) %>%
  filter(finescale_fishery_old == "NBC AABM S")%>%
  filter( season=="summer")

#Modelling comparisons need to be done on models with same # of NAs - so drop nas
Summer_north_aabm_no_nas<-Summer_north_aabm %>% drop_na(any_of(c("historic_summer", "status", "finescale_fishery_old", "season", "historic_effort")))

###Chosen model
Summer_north_aabm_model_gamma_spec<- glm(formula = catch_estimate + 1 ~ status + historic_summer:status + 1 + historic_summer,  family=Gamma(link = "log"), data = Summer_north_aabm_no_nas)

family.set <- family(Summer_north_aabm_model_gamma_spec)
ilink.family.set<- family.set$linkinv

mod<-Summer_north_aabm_model_gamma_spec

ndata<-Summer_north_aabm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))


## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))


fishery_name_north_aabm<- sort(unique(Summer_north_aabm_no_nas$finescale_fishery))

i=1

dataminmax_marked_kept<- Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total")
dataminmax_marked_released<- Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total")

dataminmax_marked_kept<- Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total")
dataminmax_marked_released<- Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total")

g1<-ggplot(Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#440154"))+  scale_fill_manual(values=c("#440154"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_kept$catch_estimate)), xlim = c(0,max(dataminmax_marked_kept$historic_summer)))

g2<-ggplot(Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
 scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#31688e"))+  scale_fill_manual(values=c("#31688e"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_released$catch_estimate)), xlim = c(0,max(dataminmax_marked_released$historic_summer)))

g3<-ggplot(Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#35b779"))+  scale_fill_manual(values=c("#35b779"))+
  coord_cartesian(ylim = c(0,max(dataminmax_unmarked_kept$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_kept$historic_summer)))

g4<-ggplot(Summer_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status, col=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#d4be02"))+  scale_fill_manual(values=c("#d4be02"))+
    coord_cartesian(ylim = c(0,max(dataminmax_unmarked_released$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_released$historic_summer)))

g<-g1+g2 + g3+g4 + plot_layout(guides = "collect") 
print(g)

```

##### Northern BC ISBM Summer Fisheries

The best model was one with a gamma distribution with a log link which included summer historic data (logbook) and marked and kept status, with no interaction of these terms.

$$ catch = historic.summer+status                                           $$

Figure \@ref(fig:fig-nbcisbm-sum-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. Figure \@ref(fig:fig-nbcisbm-summer-model) shows the summer model results in NBC ISBM.

```{r results NBC ISBM summer, results='asis', echo=FALSE}
#| label: fig-nbcisbm-summer-model
#| fig-cap: "NBC ISBM modelled results for Summer fishery"

### Data needed
Summer_north_isbm<-Sport_mark_rate_finescale_combined%>% filter(YEAR %in% c(2015:2023)) %>% filter(finescale_fishery_old == "NBC ISBM S")%>%
  filter(season %in% c("summer"))
Summer_north_isbm_no_nas<-Summer_north_isbm %>% drop_na(any_of(c("historic_summer", "status", "finescale_fishery_old")))
write_rds(Summer_north_isbm_no_nas, "Summer_north_isbm_no_nas.RDS")

#Chosen model
Summer_north_isbm_model_full_gamma_spec<- glm(formula = catch_estimate + 1 ~ status + 1 + historic_summer,  family=Gamma(link = "log"), data = Summer_north_isbm_no_nas)


family.set <- family(Summer_north_isbm_model_full_gamma_spec)
ilink.family.set<- family.set$linkinv

mod<-Summer_north_isbm_model_full_gamma_spec

ndata<-Summer_north_isbm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))

fishery_name_north_isbm<- sort(unique(Summer_north_isbm_no_nas$finescale_fishery))

i=1

 
dataminmax_marked_kept<- Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total")
dataminmax_marked_released<- Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total")

dataminmax_marked_kept<- Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total")
dataminmax_marked_released<- Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total")

g1<-ggplot(Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#440154"))+  scale_fill_manual(values=c("#440154"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_kept$catch_estimate)), xlim = c(0,max(dataminmax_marked_kept$historic_summer)))

g2<-ggplot(Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
 scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#31688e"))+  scale_fill_manual(values=c("#31688e"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_released$catch_estimate)), xlim = c(0,max(dataminmax_marked_released$historic_summer)))

g3<-ggplot(Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#35b779"))+  scale_fill_manual(values=c("#35b779"))+
  coord_cartesian(ylim = c(0,max(dataminmax_unmarked_kept$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_kept$historic_summer)))

g4<-ggplot(Summer_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status, col=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#d4be02"))+  scale_fill_manual(values=c("#d4be02"))+
    coord_cartesian(ylim = c(0,max(dataminmax_unmarked_released$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_released$historic_summer)))

g<-g1+g2 + g3+g4 + plot_layout(guides = "collect") 
print(g)
```

#### Spring and Fall models

Spring models were developed separately for all southern BC fisheries, NBC AABM and NBC ISBM.

##### Southern BC Spring and Fall fisheries

The best model was one with a gamma distribution with a log link which included summer creel, marked and kept status, finescale fishery, season, and various interactions of these terms:

$$ catch = creel.summer+finescale.fishery+season+status+                                               creel.summer:finescale.fishery  + creel.summer:status+                                               finescale.fishery:season $$

Figure \@ref(fig:fig-south-sf-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. Figure \@ref(fig:fig-jdf-fall-model) shows an example of the Spring/Fall model results in Juan de Fuca Fall fisheries.

```{r results example seasonal spring and fall, results='asis', echo=FALSE}
#| label: fig-jdf-fall-model
#| fig-cap: "Juan de Fuca modelled results for Fall fishery"

Season_south_sf<-Sport_mark_rate_finescale_combined %>%
  filter(YEAR %in% c(2013:2023))%>%
  filter(!str_detect(finescale_fishery, "CBC|NBC")) %>%
  filter(season %in% c("spring", "fall"))

#Modelling comparisons need to be done on models with same # of NAs - so drop nas
Season_south_no_nas<-Season_south_sf %>% drop_na(any_of(c("creel_plus_summer", "status", "finescale_fishery_old", "season")))

Spring_fall_model<-  glm(formula =catch_estimate + 3 ~ finescale_fishery_old + season +   status + creel_plus_summer:finescale_fishery_old + creel_plus_summer:status +  finescale_fishery_old:season + 1 + creel_plus_summer,  family=Gamma(link = "log"), data = Season_south_no_nas)

family.set <- family(Spring_fall_model)
ilink.family.set<- family.set$linkinv

mod<-Spring_fall_model

ndata<-Season_south_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(creel_plus_summer = seq(0, max(creel_plus_summer), length=100))
  

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))


fishery_name_south<- sort(unique(Season_south_no_nas$finescale_fishery))

i =1
  
  
dataminmax_marked_kept<- Season_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Kept_total")
dataminmax_marked_released<- Season_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Season_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Season_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Released_total")


g1<-ggplot(Season_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Kept_total"), aes(x=creel_plus_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Kept_total"), mapping=aes(y= fit, x=creel_plus_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Kept_total"), mapping=aes(y= fit,x=creel_plus_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#440154"))+  scale_fill_manual(values=c("#440154"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_kept$catch_estimate)), xlim = c(0,max(dataminmax_marked_kept$creel_plus_summer))) +  ggtitle(paste0("", fishery_name_south[fishery_name_south== fishery_name_south[i]], " "))

g2<-ggplot(Season_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Released_total"), aes(x=creel_plus_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Released_total"), mapping=aes(y= fit, x=creel_plus_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="marked_Released_total"), mapping=aes(y= fit,x=creel_plus_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
 scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#31688e"))+  scale_fill_manual(values=c("#31688e"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_released$catch_estimate)), xlim = c(0,max(dataminmax_marked_released$creel_plus_summer)))

g3<-ggplot(Season_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Kept_total"), aes(x=creel_plus_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Kept_total"), mapping=aes(y= fit, x=creel_plus_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Kept_total"), mapping=aes(y= fit,x=creel_plus_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#35b779"))+  scale_fill_manual(values=c("#35b779"))+
  coord_cartesian(ylim = c(0,max(dataminmax_unmarked_kept$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_kept$creel_plus_summer)))

g4<-ggplot(Season_south_no_nas %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Released_total"), aes(x=creel_plus_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Released_total"), mapping=aes(y= fit, x=creel_plus_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_south[i], status=="unmarked_Released_total"), mapping=aes(y= fit,x=creel_plus_summer, ymin = right_lwr, ymax = right_upr, fill=status, col=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#d4be02"))+  scale_fill_manual(values=c("#d4be02"))+
    coord_cartesian(ylim = c(0,max(dataminmax_unmarked_released$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_released$creel_plus_summer)))

g<-g1+g2 + g3+g4 + plot_layout(guides = "collect") 
print(g)

```

##### Northern BC AABM Spring and Fall Fisheries

The best model was one with a gamma distribution with a log link which included summer creel, marked and kept status, finescale fishery, and various interactions of these terms:

$$ catch = historic.summer+season+status+                                                historic.summer:status                                            $$

Figure \@ref(fig:fig-nbcaabm-sf-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. Figure \@ref(fig:fig-nbcaabm-fall-model) shows an example of the Fall model results in NBC AABM.

```{r results example NBC AABM seasonal spring and fall, results='asis', echo=FALSE}
#| label: fig-nbcaabm-fall-model
#| fig-cap: "NBC AABM modelled results for Fall fishery"

### Data needed
Season_north_aabm<-Sport_mark_rate_finescale_combined%>% filter(YEAR %in% c(2015:2023)) %>% filter(finescale_fishery_old == "NBC AABM S") %>%
  filter(season %in% c("spring", "fall"))
Season_north_aabm_no_nas<-Season_north_aabm %>% drop_na(any_of(c("historic_summer", "status", "finescale_fishery_old", "season", "historic_effort")))

write_rds(Season_north_aabm_no_nas, "Season_north_aabm_no_nas.RDS")

###Chosen model
North_aabm_model<- glm(formula = catch_estimate + 1 ~ season + status + historic_summer:season + 1 + historic_summer,  family=Gamma(link = "log"), data = Season_north_aabm_no_nas)


family.set <- family(North_aabm_model)
ilink.family.set<- family.set$linkinv

mod<-North_aabm_model

ndata<-Season_north_aabm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))


## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))


fishery_name_north_aabm<- sort(unique(Season_north_aabm_no_nas$finescale_fishery))

i=1 


dataminmax_marked_kept<- Season_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total")
dataminmax_marked_released<- Season_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Season_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Season_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total")

g1<-ggplot(Season_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#440154"))+  scale_fill_manual(values=c("#440154"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_kept$catch_estimate)), xlim = c(0,max(dataminmax_marked_kept$historic_summer))) + ggtitle(paste0(fishery_name_north_aabm[fishery_name_north_aabm== fishery_name_north_aabm[i]], " "))

g2<-ggplot(Season_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="marked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
 scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#31688e"))+  scale_fill_manual(values=c("#31688e"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_released$catch_estimate)), xlim = c(0,max(dataminmax_marked_released$historic_summer)))

g3<-ggplot(Season_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#35b779"))+  scale_fill_manual(values=c("#35b779"))+
  coord_cartesian(ylim = c(0,max(dataminmax_unmarked_kept$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_kept$historic_summer)))

g4<-ggplot(Season_north_aabm_no_nas %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_aabm[i], status=="unmarked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status, col=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#d4be02"))+  scale_fill_manual(values=c("#d4be02"))+
    coord_cartesian(ylim = c(0,max(dataminmax_unmarked_released$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_released$historic_summer)))

g<-g1+g2 + g3+g4 + plot_layout(guides = "collect") 
print(g)

```

##### Northern BC ISBM Spring and Fall Fisheries

The best model was one with a gamma distribution with a log link which included summer creel, marked and kept status, finescale fishery, and various interactions of these terms:

$$ catch = historic.summer+season+status+                                                season:status                                            $$

Figure \@ref(fig:fig-nbcisbm-sf-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. Figure \@ref(fig:fig-nbcisbm-fall-model) shows an example of the Fall model results in NBC ISBM.

```{r results example NBC ISBM seasonal spring and fall, results='asis', echo=FALSE}
#| label: fig-nbcisbm-fall-model
#| fig-cap: "NBC ISBM modelled results for Fall fishery"

Season_nbc_isbm<-Sport_mark_rate_finescale_combined%>% filter(YEAR %in% c(2015:2023)) %>% filter(finescale_fishery_old == "NBC ISBM S")%>%
  filter(season %in% c("spring", "fall"))

Season_north_isbm_no_nas<-Season_nbc_isbm %>% drop_na(any_of(c("historic_summer", "status", "finescale_fishery_old", "season")))


###Chosen model
nbc_isbm_model_full_gamma_spec<- glm(formula = catch_estimate + 1 ~ season + status + season:status + 1 + historic_summer,  family=Gamma(link = "log"), data = Season_north_isbm_no_nas)

family.set <- family(nbc_isbm_model_full_gamma_spec)
ilink.family.set<- family.set$linkinv

mod<-nbc_isbm_model_full_gamma_spec

ndata<-Season_north_isbm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))


fishery_name_north_isbm<- sort(unique(Season_north_isbm_no_nas$finescale_fishery))

i=1

 
dataminmax_marked_kept<- Season_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total")
dataminmax_marked_released<- Season_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Season_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Season_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total")


g1<-ggplot(Season_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#440154"))+  scale_fill_manual(values=c("#440154"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_kept$catch_estimate)), xlim = c(0,max(dataminmax_marked_kept$historic_summer))) + ggtitle(paste0(fishery_name_north_isbm[fishery_name_north_isbm== fishery_name_north_isbm[i]], " "))

g2<-ggplot(Season_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="marked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
 scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#31688e"))+  scale_fill_manual(values=c("#31688e"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_released$catch_estimate)), xlim = c(0,max(dataminmax_marked_released$historic_summer)))

g3<-ggplot(Season_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#35b779"))+  scale_fill_manual(values=c("#35b779"))+
  coord_cartesian(ylim = c(0,max(dataminmax_unmarked_kept$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_kept$historic_summer)))

g4<-ggplot(Season_north_isbm_no_nas %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_north_isbm[i], status=="unmarked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status, col=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#d4be02"))+  scale_fill_manual(values=c("#d4be02"))+
    coord_cartesian(ylim = c(0,max(dataminmax_unmarked_released$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_released$historic_summer)))

g<-g1+g2 + g3+g4 + plot_layout(guides = "collect") 
print(g)
```

#### Year round model

##### CBC

The best model was one with a gamma distribution with a log link which included historic estimates (logbook), marked and kept status.

$$ catch = historic.summer+status                                          $$

Figure \@ref(fig:fig-cbc-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. Figure \@ref(fig:fig-cbc-model) shows the CBC model results.

```{r results CBC model, results='asis', echo=FALSE}
#| label: fig-cbc-model
#| fig-cap: "CBC modelled results for year round fishery"

Season_cbc_isbm<-Sport_mark_rate_finescale_combined%>% filter(YEAR %in% c(2015:2023)) %>% filter(finescale_fishery_old == "CBC S")

#Modelling comparisons need to be done on models with same # of NAs - so drop nas
Season_cbc_isbm_no_nas<-Season_cbc_isbm %>% drop_na(any_of(c("historic_summer", "status")))

#Chosen model:
cbc_isbm_model<- glm(formula = catch_estimate + 1 ~  status + 1 + historic_summer,  family=Gamma(link = "log"), data = Season_cbc_isbm_no_nas)

family.set <- family(cbc_isbm_model)
ilink.family.set<- family.set$linkinv

mod<-cbc_isbm_model

ndata<-Season_cbc_isbm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))

fishery_name_cbc_isbm<- sort(unique(Season_cbc_isbm_no_nas$finescale_fishery))

i=1


dataminmax_marked_kept<- Season_cbc_isbm_no_nas %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="marked_Kept_total")
dataminmax_marked_released<- Season_cbc_isbm_no_nas %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="marked_Released_total")
dataminmax_unmarked_kept<- Season_cbc_isbm_no_nas %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="unmarked_Kept_total")
dataminmax_unmarked_released<- Season_cbc_isbm_no_nas %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="unmarked_Released_total")

g1<-ggplot(Season_cbc_isbm_no_nas %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="marked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="marked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="marked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#440154"))+  scale_fill_manual(values=c("#440154"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_kept$catch_estimate)), xlim = c(0,max(dataminmax_marked_kept$historic_summer)))+ ggtitle(paste0(fishery_name_cbc_isbm[fishery_name_cbc_isbm== fishery_name_cbc_isbm[i]], " "))

g2<-ggplot(Season_cbc_isbm_no_nas %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="marked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="marked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="marked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
 scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#31688e"))+  scale_fill_manual(values=c("#31688e"))+
  coord_cartesian(ylim = c(0,max(dataminmax_marked_released$catch_estimate)), xlim = c(0,max(dataminmax_marked_released$historic_summer)))

g3<-ggplot(Season_cbc_isbm_no_nas %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="unmarked_Kept_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="unmarked_Kept_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status), alpha = 0.10)+
  theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#35b779"))+  scale_fill_manual(values=c("#35b779"))+
  coord_cartesian(ylim = c(0,max(dataminmax_unmarked_kept$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_kept$historic_summer)))

g4<-ggplot(Season_cbc_isbm_no_nas %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="unmarked_Released_total"), aes(x=historic_summer,  y= catch_estimate, col=status))+
  geom_point()+
  geom_line(ndata %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="unmarked_Released_total"), mapping=aes(y= fit, x=historic_summer, col=status))+
  geom_ribbon(ndata %>% filter(finescale_fishery==fishery_name_cbc_isbm[i], status=="unmarked_Released_total"), mapping=aes(y= fit,x=historic_summer, ymin = right_lwr, ymax = right_upr, fill=status, col=status), alpha = 0.10)+
   theme_bw() +
  scale_size_continuous(range=c(1,3))+ scale_colour_manual(values=c("#d4be02"))+  scale_fill_manual(values=c("#d4be02"))+
    coord_cartesian(ylim = c(0,max(dataminmax_unmarked_released$catch_estimate)), xlim = c(0,max(dataminmax_unmarked_released$historic_summer)))

g<-g1+g2 + g3+g4 + plot_layout(guides = "collect") 
print(g)

```

### Model validation using sport head recoveries

We used the sport head recovery program to validate the model results.

```{r results Loading packages, useful functions, echo=FALSE}
#load packages
library(dplyr)
library(readr)
library(ggplot2)
library(ROracle)

#utils
"%notin%" <- Negate("%in%")
sport_catch <- Sport_mark_rate_finescale_combined
head_df <-  pacRecCatch::get_head_totals()

lm_eqn <- function(df){
  m <- lm(head_total ~ catch_estimate_predicted + 0, df)
  
  eq <- substitute(italic(y) == a %.% italic(x)*","~~italic(r)^2~"="~r2*"," ~~italic(n)*"="~df_n,
                   list(a = format(unname(coef(m)[1]), digits = 3),
                        b = format(unname(coef(m)[2]), digits = 3),
                        r2 = format(summary(m)$r.squared, digits = 3),
                        df_n = nrow(df)))
  as.character(as.expression(eq));
}

models_combined2 <-
  models_combined |>
  mutate(finescale_fishery = if_else(grepl("NWCVI|SWCVI", finescale_fishery), 
                                     trimws(gsub(" ISBM|AABM", "", finescale_fishery)),
                                     finescale_fishery)) |>
  group_by(YEAR, status, finescale_fishery, season, mark_status, kept_status) |>
  summarize(catch_estimate_predicted = sum(catch_estimate_predicted, na.rm=TRUE),
            .groups = "drop")

head_df <-
  head_df |>
  mutate(region = if_else(grepl("NWCVI|SWCVI", region), 
                          trimws(gsub(" ISBM|AABM", "", region)),
                          region)) |>
  group_by(year, region) |>
  summarize(head_total = sum(head_total, na.rm=TRUE),
            .groups = "drop")

head_catch_df <-
  models_combined2 |>
  filter(status == "marked_Kept_total") |>
  full_join(head_df, c(YEAR="year", finescale_fishery = "region")) |>
  mutate(YEAR = as.integer(YEAR),
         submit_rate = head_total/catch_estimate_predicted) |>
  filter(catch_estimate_predicted > 50)

head_catch_model_df <-
  head_catch_df |>
  filter(catch_estimate_predicted > 0, 
         coalesce(head_total, 0) > 0,
         coalesce(catch_estimate_predicted,0) > 0)

```

```{r results Head to Kept Mark Catch, echo=FALSE}

ggplot(data = head_catch_model_df, aes(x=catch_estimate_predicted,
                                       y=head_total)) +
  geom_point(size=2) +
  geom_smooth(method='lm', formula= y~x + 0) +
  geom_text(x = 500, y = 5000, label = lm_eqn(head_catch_model_df), parse = TRUE, hjust=0, vjust=0) +
  ggtitle("Chinook Head to Clipped Catch") +
  xlab("Chinook Kept Adclipped Catch") + 
  ylab("Chinook Head Recoveries")


```

```{r results Pre iRec Head to Kept Mark Catch, echo=FALSE}

pre_irec_catch_model_df <- 
  head_catch_model_df |>
  filter(YEAR < 2013)

eq_y_pos <- max(pre_irec_catch_model_df$head_total, na.rm=0) * 0.9

ggplot(data = pre_irec_catch_model_df,
       aes(x=catch_estimate_predicted, y=head_total)) +
  geom_point(size=2) +
  geom_smooth(method='lm', formula= y~x + 0) +
  geom_text(x = 500, y = eq_y_pos, label = lm_eqn(pre_irec_catch_model_df), parse = TRUE, hjust=0, vjust=0) +
  ggtitle("Before iRec Chinook Head to Clipped Catch") +
  xlab("Chinook Kept Adclipped Catch") + 
  ylab("Chinook Head Recoveries")

```

```{r results Post iRec Head to Kept Mark Catch, echo=FALSE}

post_irec_catch_model_df <- 
  head_catch_model_df |>
  filter(YEAR >= 2013)

eq_y_pos <- max(post_irec_catch_model_df$head_total, na.rm=0) * 0.9

ggplot(data = post_irec_catch_model_df,
       aes(x=catch_estimate_predicted, y=head_total)) +
  geom_point(size=2) +
  geom_smooth(method='lm', formula= y~x + 0) +
  geom_text(x = 500, y = eq_y_pos, label = lm_eqn(post_irec_catch_model_df), parse = TRUE, hjust=0, vjust=0) +
  ggtitle("iRec Chinook Head to Clipped Catch") +
  xlab("Chinook Kept Adclipped Catch") + 
  ylab("Chinook Head Recoveries")

```

```{r results Fishery Rates, echo=FALSE}

ggplot(data = head_catch_model_df, aes(x=YEAR, y=submit_rate, color=finescale_fishery)) +
  geom_line(linewidth = 2)

```

```{r results pre IRec Fishery Rates, echo=FALSE}

ggplot(data = pre_irec_catch_model_df, aes(x=YEAR, y=submit_rate, color=finescale_fishery)) +
  geom_line(linewidth = 2)

```

## 

## Incorporation of both sets of revised estimates in Chinook Technical Committee processes

### Catch and Escapement Reporting Kept and Released Catch

-   *C&E Report results here (Fig 3 and 4 of the memo)*

```{r results CandEkept, results='asis', echo=FALSE}
#| label: fig-cande-kept
#| fig-cap: "Revised (blue) and previously reported (green) kept catch estimates from 2005-2023. Revised estimates prior to 2012 (vertical line) are from modelled data, whereas 2013 onwards is observed data. "


cnr_canada_sport<-read.csv("data/cnr_canada_sport.csv") %>% as_tibble() %>% filter(year>2004)

fishery_map<-models_combined %>% dplyr::select(finescale_fishery_old, finescale_fishery) %>%
  mutate(erafishery = case_when(
    finescale_fishery_old %in% c("NWCVI S AABM", "SWCVI S AABM") ~ "WCVI AABM S",
    finescale_fishery_old %in% c("NGS S", "SGS S") ~  "GEO ST S",
    finescale_fishery_old == "CA JDF S" ~ "BC JF S",
    finescale_fishery_old %in%  c("NWCVI S ISBM", "SWCVI S ISBM") ~ "WCVI ISBM S",
    TRUE ~ finescale_fishery_old
  )) %>% unique()

cnr_canada_sport<-cnr_canada_sport %>% left_join(fishery_map) %>% rename(YEAR=year)

Sport_mark_rate_mrr<- Sport_mark_rate_mrr_corrected %>% left_join(cnr_canada_sport)
Sport_mark_rate_mrr<-Sport_mark_rate_mrr %>% mutate(Kept_total = marked_Kept_total + unmarked_Kept_total,
                                                    Released_total = marked_Released_total + unmarked_Released_total)


cnr_canada_sport_short<- cnr_canada_sport %>% dplyr::select(-finescale_fishery, -finescale_fishery_old) %>% unique()

Sport_mark_rate_mrr_sum<-Sport_mark_rate_mrr %>% dplyr::select(-Kept, -Released, -Release_rate) %>% group_by(erafishery, YEAR) %>%   summarise_if(is.numeric, sum, na.rm = TRUE)
Sport_mark_rate_mrr_sum<-Sport_mark_rate_mrr_sum  %>% left_join(cnr_canada_sport_short)

rec_summary<-read.csv("data/rec_summary_2005-2023.csv") %>% as_tibble()
Sport_mark_rate_mrr_sum<-Sport_mark_rate_mrr_sum  %>% left_join(rec_summary)
Sport_mark_rate_mrr_sum<-Sport_mark_rate_mrr_sum %>% filter(!is.na(erafishery))

## Kept only
k<-ggplot() +
  geom_point(data=Sport_mark_rate_mrr_sum, aes(y=Kept_total, x=YEAR, col="lightblue4")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=Kept_total, x=YEAR, col="lightblue4"))+
  geom_point(data=Sport_mark_rate_mrr_sum, aes(y=total_kept, x=YEAR, col="lightgreen")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=total_kept, x=YEAR, col="lightgreen"))+
 # geom_point(data=Sport_mark_rate_mrr_sum, aes(y=Kept, x=YEAR, col="darkgreen")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=Kept, x=YEAR, col="darkgreen"))+

  scale_color_manual(values=c("lightblue4", "lightgreen"),  labels = c("Revised estimates", "2024 C&E Report"))+
  theme(legend.position="bottom")+
  ylab("Kept Catch")+
  facet_wrap(~erafishery, scales = "free", ncol=4)+
  theme_bw()+ geom_vline(xintercept = 2012)+
  labs(col = "Data source")

print(k)

```

Released

```{r results CandEreleased, results='asis', echo=FALSE}
#| label: fig-cande-released
#| fig-cap: "Revised (blue) and previously reported (green) released catch estimates from 2005-2023. Revised estimates prior to 2012 (vertical line) are from modelled data, whereas 2013 onwards is observed data. "


## Released only
r<-ggplot() +
  geom_point(data=Sport_mark_rate_mrr_sum, aes(y=Released_total, x=YEAR, col="lightblue4")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=Released_total, x=YEAR, col="lightblue4"))+
  geom_point(data=Sport_mark_rate_mrr_sum, aes(y=legal_releases, x=YEAR, col="lightgreen")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=legal_releases, x=YEAR, col="lightgreen"))+
 # geom_point(data=Sport_mark_rate_mrr_sum, aes(y=Released, x=YEAR, col="darkgreen")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=Released, x=YEAR, col="darkgreen"))+

  scale_color_manual(values=c( "lightblue4", "lightgreen"),  labels = c("Revised estimates", "2024 C&E Report"))+
  theme(legend.position="bottom")+
  ylab("Released Catch")+
  facet_wrap(~erafishery, scales = "free", ncol=4)+
  theme_bw()+ geom_vline(xintercept = 2012)+
  labs(col = "Data source")

print(r)
```

### Updating CWT estimates

-   *CWT results here*

### Updating Chinook non-retention (release) estimates

-   *MRR/UKR results here compared to CNR file (Fig 5 of the memo)*

```{r results mrrukr, results='asis', echo=FALSE}
#| label: fig-mrrukr
#| fig-cap: "Release rates at the finescale fishery level, over time from 2005 to 2023. Light blue lines are release rates of unmarked fish and dark blue lines are release rates of marked fish, from revised data. Green lines are release rates (regardless of mark status) used in the 2024 CNR files to the ERA."


Sport_mark_rate_mrr<-Sport_mark_rate_mrr %>% filter(!is.na(erafishery))

mu<-ggplot() +
  geom_point(data=Sport_mark_rate_mrr, aes(y=(1-ukr), x=YEAR, col="lightblue")) + geom_line(data=Sport_mark_rate_mrr, aes(y=1-ukr, x=YEAR, col="lightblue"))+
  geom_point(data=Sport_mark_rate_mrr, aes(y=mrr, x=YEAR, col="lightblue4")) + geom_line(data=Sport_mark_rate_mrr, aes(y=mrr, x=YEAR, col="lightblue4"))+
  geom_point(data=Sport_mark_rate_mrr, aes(y=Release_rate, x=YEAR, col="lightgreen")) + geom_line(data=Sport_mark_rate_mrr, aes(y=Release_rate, x=YEAR, col="lightgreen"))+
  scale_color_manual(values=c("lightblue", "lightblue4", "lightgreen"),  labels = c("Revised Unmarked Release Rate", "Revised Marked Release Rate", "2024 CNR Release Rate"))+
  theme(legend.position="bottom")+
  ylab("Proportion")+
  facet_wrap(~finescale_fishery)+
  theme_bw()+ geom_vline(xintercept = 2012)+
  labs(col="Data source")+
  theme(legend.position = "bottom")

print(mu)
```
